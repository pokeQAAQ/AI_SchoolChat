# -*- coding: utf-8 -*-
"""
Áü•ËØÜÂ∫ì‰∏ä‰º†ÊúçÂä°Âô®
Áî®‰∫éÊé•Êî∂ÊâãÊú∫Á´Ø‰∏ä‰º†ÁöÑÂ≠¶Ê†°Áü•ËØÜ‰ø°ÊÅØ
"""
import os
import json
from datetime import datetime
from flask import Flask, request, render_template_string, jsonify, redirect, url_for
from knowledge_manager import knowledge_manager
import socket
from werkzeug.utils import secure_filename
import shutil

app = Flask(__name__)

# ÈÖçÁΩÆÁü•ËØÜÂ∫ìÊñá‰ª∂Â≠òÂÇ®
KNOWLEDGE_BASE_DIR = os.environ.get('KNOWLEDGE_BASE_DIR', './data/knowledge_base')
KNOWLEDGE_BASE_MAX_BYTES = int(os.environ.get('KNOWLEDGE_BASE_MAX_BYTES', '1073741824'))  # 1GB
KNOWLEDGE_BASE_MAX_FILE_BYTES = int(os.environ.get('KNOWLEDGE_BASE_MAX_FILE_BYTES', '10485760'))  # 10MB

# ÂÖÅËÆ∏ÁöÑÊñá‰ª∂Êâ©Â±ïÂêç
ALLOWED_EXTENSIONS = {'.pdf', '.doc', '.docx', '.md', '.markdown', '.txt'}

# ËÆæÁΩÆFlaskÊúÄÂ§ßÂÜÖÂÆπÈïøÂ∫¶
app.config['MAX_CONTENT_LENGTH'] = KNOWLEDGE_BASE_MAX_FILE_BYTES

def ensure_knowledge_base_dir():
    """Á°Æ‰øùÁü•ËØÜÂ∫ìÁõÆÂΩïÂ≠òÂú®"""
    if not os.path.exists(KNOWLEDGE_BASE_DIR):
        os.makedirs(KNOWLEDGE_BASE_DIR, exist_ok=True)

def get_folder_size(folder_path):
    """ÈÄíÂΩíËÆ°ÁÆóÊñá‰ª∂Â§πÂ§ßÂ∞è"""
    if not os.path.exists(folder_path):
        return 0
    
    total_size = 0
    for dirpath, dirnames, filenames in os.walk(folder_path):
        for filename in filenames:
            file_path = os.path.join(dirpath, filename)
            try:
                total_size += os.path.getsize(file_path)
            except (OSError, IOError):
                pass
    return total_size

def format_bytes(bytes_count):
    """Â∞ÜÂ≠óËäÇÊï∞ËΩ¨Êç¢‰∏∫‰∫∫Á±ªÂèØËØªÊ†ºÂºè"""
    for unit in ['B', 'KB', 'MB', 'GB']:
        if bytes_count < 1024.0:
            return f"{bytes_count:.1f} {unit}"
        bytes_count /= 1024.0
    return f"{bytes_count:.1f} TB"

def is_allowed_file(filename):
    """Ê£ÄÊü•Êñá‰ª∂Êâ©Â±ïÂêçÊòØÂê¶ÂÖÅËÆ∏"""
    return any(filename.lower().endswith(ext) for ext in ALLOWED_EXTENSIONS)

def get_unique_filename(directory, filename):
    """ÁîüÊàêÂîØ‰∏ÄÁöÑÊñá‰ª∂ÂêçÔºàÈÅøÂÖçÈáçÂ§çÔºâ"""
    if not os.path.exists(os.path.join(directory, filename)):
        return filename
    
    name, ext = os.path.splitext(filename)
    counter = 1
    while True:
        new_filename = f"{name}_{counter}{ext}"
        if not os.path.exists(os.path.join(directory, new_filename)):
            return new_filename
        counter += 1

# ÂêØÂä®Êó∂ÂàõÂª∫Áü•ËØÜÂ∫ìÁõÆÂΩï
ensure_knowledge_base_dir()

# Ëé∑ÂèñËÆæÂ§á‰ø°ÊÅØ
def get_device_info():
    """Ëé∑ÂèñËÆæÂ§áÂü∫Êú¨‰ø°ÊÅØ"""
    try:
        hostname = socket.gethostname()
        # Ëé∑ÂèñÂΩìÂâçIPÂú∞ÂùÄ
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        s.connect(("8.8.8.8", 80))
        ip = s.getsockname()[0]
        s.close()
        return {
            'hostname': hostname,
            'ip': ip,
            'mac': '60:e9:cd:e8:cc:aa'  # ‰ªé‰πãÂâçËé∑ÂèñÁöÑMACÂú∞ÂùÄ
        }
    except:
        return {
            'hostname': 'orangepi-zero3',
            'ip': '192.168.4.1',
            'mac': '60:e9:cd:e8:cc:aa'
        }

# ‰∏ä‰º†Ë°®ÂçïÈ°µÈù¢
UPLOAD_TEMPLATE = """
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö Ê†°Âõ≠Êô∫ËÉΩÂ∞èÂä©Êâã - Áü•ËØÜ‰∏ä‰º†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #4a90e2, #357abd);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .device-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 12px;
            text-align: left;
        }
        
        .form-container {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }
        
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        
        .submit-btn {
            width: 100%;
            background: linear-gradient(45deg, #4a90e2, #357abd);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
        }
        
        .submit-btn:active {
            transform: translateY(0);
        }
        
        .tips {
            background: #f8f9fa;
            padding: 20px;
            border-left: 4px solid #4a90e2;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }
        
        .tips h3 {
            color: #4a90e2;
            margin-bottom: 10px;
        }
        
        .tips ul {
            padding-left: 20px;
            color: #666;
        }
        
        .tips li {
            margin-bottom: 5px;
        }
        
        .status {
            text-align: center;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Êñá‰ª∂‰∏ä‰º†ÈÉ®ÂàÜÊ†∑Âºè */
        .file-upload-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e9ecef;
        }
        
        .section-header h3 {
            color: #4a90e2;
            margin-bottom: 8px;
            font-size: 18px;
        }
        
        .section-subtext {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        
        .usage-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .usage-text {
            margin-bottom: 10px;
            font-size: 14px;
            color: #495057;
            font-weight: 500;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .progress-bar {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .file-input-container {
            margin-bottom: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-input-label {
            display: block;
            padding: 15px;
            background: #f8f9fa;
            border: 2px dashed #4a90e2;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            color: #4a90e2;
            font-weight: 500;
        }
        
        .file-input-label:hover {
            background: #e9f4ff;
            border-color: #357abd;
        }
        
        .selected-files {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            display: none;
        }
        
        .selected-file {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .selected-file:last-child {
            border-bottom: none;
        }
        
        .file-name {
            color: #495057;
            font-size: 14px;
        }
        
        .file-size {
            color: #6c757d;
            font-size: 12px;
        }
        
        .upload-btn {
            width: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        .upload-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .upload-btn:active:not(:disabled) {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Ê†°Âõ≠Êô∫ËÉΩÂ∞èÂä©Êâã</h1>
            <p>‰∏ä‰º†Â≠¶Ê†°Áü•ËØÜÔºåËÆ©AIÊõ¥ÊáÇÊÇ®ÁöÑÊ†°Âõ≠</p>
            <div class="device-info">
                <div>üì° ËÆæÂ§á: {{ device_info.hostname }}</div>
                <div>üåê IP: {{ device_info.ip }}</div>
                <div>üîó MAC: {{ device_info.mac }}</div>
            </div>
        </div>
        
        <div class="form-container">
            <div class="tips">
                <h3>üìù ‰∏ä‰º†ËØ¥Êòé</h3>
                <ul>
                    <li>ËØ∑Â°´ÂÜôÊÇ®Â≠¶Ê†°ÁöÑÁõ∏ÂÖ≥‰ø°ÊÅØÔºåÂ∏ÆÂä©AIÊõ¥Â•ΩÂú∞ÂõûÁ≠îÊ†°Âõ≠ÈóÆÈ¢ò</li>
                    <li>ÂèØ‰ª•Âè™Â°´ÂÜôÈÉ®ÂàÜÂÜÖÂÆπÔºå‰∏çÂøÖÂÖ®ÈÉ®Â°´ÂÜô</li>
                    <li>ÂÜÖÂÆπ‰ºö‰øùÂ≠òÂú®Êú¨Âú∞Ôºå‰∏ç‰ºö‰∏ä‰º†Âà∞Â§ñÁΩë</li>
                    <li>ÊîØÊåÅ‰∏≠ÊñáÂÜÖÂÆπÔºåËØ∑Â∞ΩÈáèËØ¶ÁªÜÊèèËø∞</li>
                </ul>
            </div>
            
            <form id="uploadForm" method="POST" action="/upload">
                <div class="form-group">
                    <label for="school_info">üè´ Â≠¶Ê†°ÁÆÄ‰ªã</label>
                    <textarea 
                        id="school_info" 
                        name="school_info" 
                        rows="6" 
                        placeholder="ËØ∑‰ªãÁªçÊÇ®ÁöÑÂ≠¶Ê†°Ôºå‰æãÂ¶ÇÔºöÂ≠¶Ê†°ÂêçÁß∞„ÄÅÂª∫Ê†°Êó∂Èó¥„ÄÅÂäûÂ≠¶ÁâπËâ≤„ÄÅ‰∏ì‰∏öËÆæÁΩÆ„ÄÅÊ†°Âõ≠ÁéØÂ¢ÉÁ≠â...">{{ form_data.school_info or '' }}</textarea>
                </div>
                
                <div class="form-group">
                    <label for="history">üìú Ê†°Âè≤Ê≤øÈù©</label>
                    <textarea 
                        id="history" 
                        name="history" 
                        rows="6" 
                        placeholder="ËØ∑‰ªãÁªçÂ≠¶Ê†°ÁöÑÂéÜÂè≤ÂèëÂ±ïÔºå‰æãÂ¶ÇÔºöÈáçË¶ÅÂéÜÂè≤ËäÇÁÇπ„ÄÅÂèëÂ±ïÂéÜÁ®ã„ÄÅÈáçÂ§ß‰∫ã‰ª∂„ÄÅÂéÜÂè≤ÂèòËøÅÁ≠â...">{{ form_data.history or '' }}</textarea>
                </div>
                
                <div class="form-group">
                    <label for="celebrities">üåü Áü•ÂêçÊ†°Âèã</label>
                    <textarea 
                        id="celebrities" 
                        name="celebrities" 
                        rows="6" 
                        placeholder="ËØ∑‰ªãÁªçÁü•ÂêçÊ†°ÂèãÊàñÊïôÂ∏àÔºå‰æãÂ¶ÇÔºöÂßìÂêç„ÄÅ‰∏ì‰∏ö„ÄÅÊàêÂ∞±„ÄÅË¥°ÁåÆ„ÄÅÁé∞‰ªªËÅå‰ΩçÁ≠â...">{{ form_data.celebrities or '' }}</textarea>
                </div>
                
                <button type="submit" class="submit-btn">üöÄ ‰∏ä‰º†Áü•ËØÜ</button>
            </form>
            
            <div id="status" class="status"></div>
            
            <!-- Êñá‰ª∂‰∏ä‰º†ÈÉ®ÂàÜ -->
            <div class="file-upload-section">
                <div class="section-header">
                    <h3>üìÅ ‰∏ä‰º†Êú¨Âú∞Áü•ËØÜÂ∫ì</h3>
                    <p class="section-subtext">ÊîØÊåÅ .pdf .doc .docx .md .markdown .txt„ÄÇÂ∞ÜÊñá‰ª∂‰øùÂ≠òÂà∞Êú¨Âú∞Áü•ËØÜÂ∫ìÊñá‰ª∂Â§πÔºå‰ªÖÁî®‰∫éÂ≠òÂÇ®Ôºå‰∏çÂèÇ‰∏éÂØπËØù„ÄÇ</p>
                </div>
                
                <div class="usage-display">
                    <div class="usage-text">
                        <span id="usage-info">Ê≠£Âú®Âä†ËΩΩÂ≠òÂÇ®‰ø°ÊÅØ...</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar">
                            <div id="progress-fill" class="progress-fill"></div>
                        </div>
                    </div>
                </div>
                
                <form id="fileUploadForm" enctype="multipart/form-data">
                    <div class="file-input-container">
                        <input type="file" id="files" name="files" multiple accept=".pdf,.doc,.docx,.md,.markdown,.txt" class="file-input">
                        <label for="files" class="file-input-label">
                            üìé ÈÄâÊã©Êñá‰ª∂ (ÂèØÂ§öÈÄâ)
                        </label>
                        <div id="selected-files" class="selected-files"></div>
                    </div>
                    
                    <button type="submit" id="upload-btn" class="upload-btn" disabled>
                        üì§ ‰∏ä‰º†Êñá‰ª∂
                    </button>
                </form>
                
                <div id="file-status" class="status"></div>
            </div>
        </div>
    </div>
    
    <script>
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const statusDiv = document.getElementById('status');
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÂÜÖÂÆπ
            const schoolInfo = formData.get('school_info').trim();
            const history = formData.get('history').trim();
            const celebrities = formData.get('celebrities').trim();
            
            if (!schoolInfo && !history && !celebrities) {
                statusDiv.className = 'status error';
                statusDiv.style.display = 'block';
                statusDiv.textContent = '‚ö†Ô∏è ËØ∑Ëá≥Â∞ëÂ°´ÂÜô‰∏ÄÈ°πÂÜÖÂÆπ';
                return;
            }
            
            // ÊòæÁ§∫‰∏ä‰º†‰∏≠
            statusDiv.className = 'status';
            statusDiv.style.display = 'block';
            statusDiv.textContent = 'üì§ Ê≠£Âú®‰∏ä‰º†...';
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ ' + data.message;
                    // Ê∏ÖÁ©∫Ë°®Âçï
                    document.getElementById('uploadForm').reset();
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå ' + data.message;
                }
            })
            .catch(error => {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå ‰∏ä‰º†Â§±Ë¥•Ôºö' + error.message;
            });
        });
    </script>
    
    <!-- Êñá‰ª∂‰∏ä‰º†ÂäüËÉΩËÑöÊú¨ -->
    <script>
        // Âä†ËΩΩÂ≠òÂÇ®‰ΩøÁî®ÊÉÖÂÜµ
        function loadUsageInfo() {
            fetch('/kb/usage')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('usage-info').textContent = 'Âä†ËΩΩÂ≠òÂÇ®‰ø°ÊÅØÂ§±Ë¥•';
                        return;
                    }
                    
                    const usageText = `Â∑≤‰ΩøÁî®: ${data.used_human} / ${data.max_human} (${data.percent}%)`;
                    document.getElementById('usage-info').textContent = usageText;
                    document.getElementById('progress-fill').style.width = data.percent + '%';
                    
                    // Â¶ÇÊûúÂ≠òÂÇ®Â∑≤Êª°ÔºåÁ¶ÅÁî®‰∏ä‰º†ÊåâÈíÆ
                    const uploadBtn = document.getElementById('upload-btn');
                    if (data.percent >= 100) {
                        uploadBtn.disabled = true;
                        uploadBtn.textContent = 'üì¶ Â≠òÂÇ®Â∑≤Êª°';
                    }
                })
                .catch(error => {
                    console.error('Âä†ËΩΩÂ≠òÂÇ®‰ø°ÊÅØÂ§±Ë¥•:', error);
                    document.getElementById('usage-info').textContent = 'Âä†ËΩΩÂ≠òÂÇ®‰ø°ÊÅØÂ§±Ë¥•';
                });
        }
        
        // Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
        function formatFileSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            let size = bytes;
            let unitIndex = 0;
            
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            
            return `${size.toFixed(1)} ${units[unitIndex]}`;
        }
        
        // Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
        document.getElementById('files').addEventListener('change', function(e) {
            const files = e.target.files;
            const selectedFilesDiv = document.getElementById('selected-files');
            const uploadBtn = document.getElementById('upload-btn');
            
            if (files.length > 0) {
                selectedFilesDiv.style.display = 'block';
                selectedFilesDiv.innerHTML = '';
                
                for (let file of files) {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'selected-file';
                    fileDiv.innerHTML = `
                        <span class="file-name">${file.name}</span>
                        <span class="file-size">${formatFileSize(file.size)}</span>
                    `;
                    selectedFilesDiv.appendChild(fileDiv);
                }
                
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üì§ ‰∏ä‰º†Êñá‰ª∂';
            } else {
                selectedFilesDiv.style.display = 'none';
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'üì§ ‰∏ä‰º†Êñá‰ª∂';
            }
        });
        
        // Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†
        document.getElementById('fileUploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const files = document.getElementById('files').files;
            const statusDiv = document.getElementById('file-status');
            const uploadBtn = document.getElementById('upload-btn');
            
            if (files.length === 0) {
                statusDiv.className = 'status error';
                statusDiv.style.display = 'block';
                statusDiv.textContent = '‚ö†Ô∏è ËØ∑ÈÄâÊã©Ë¶Å‰∏ä‰º†ÁöÑÊñá‰ª∂';
                return;
            }
            
            // Ê∑ªÂä†ÊâÄÊúâÊñá‰ª∂Âà∞FormData
            for (let file of files) {
                formData.append('files', file);
            }
            
            // ÊòæÁ§∫‰∏ä‰º†‰∏≠Áä∂ÊÄÅ
            statusDiv.className = 'status';
            statusDiv.style.display = 'block';
            statusDiv.textContent = 'üì§ Ê≠£Âú®‰∏ä‰º†Êñá‰ª∂...';
            uploadBtn.disabled = true;
            uploadBtn.textContent = '‚è≥ ‰∏ä‰º†‰∏≠...';
            
            fetch('/kb/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.className = 'status success';
                    let message = data.message;
                    
                    // ÊòæÁ§∫ËØ¶ÁªÜÁªìÊûú
                    if (data.results && data.results.length > 0) {
                        message += '\\n\\nËØ¶ÁªÜÁªìÊûúÔºö';
                        data.results.forEach(result => {
                            if (result.success) {
                                message += `\\n‚úÖ ${result.filename} (${result.size})`;
                            } else {
                                message += `\\n‚ùå ${result.filename}: ${result.message}`;
                            }
                        });
                    }
                    
                    statusDiv.textContent = message;
                    
                    // Ê∏ÖÁ©∫Ë°®Âçï
                    document.getElementById('fileUploadForm').reset();
                    document.getElementById('selected-files').style.display = 'none';
                    
                    // Êõ¥Êñ∞Â≠òÂÇ®‰ΩøÁî®ÊÉÖÂÜµ
                    if (data.usage) {
                        const usageText = `Â∑≤‰ΩøÁî®: ${data.usage.used_human} / ${data.usage.max_human} (${data.usage.percent}%)`;
                        document.getElementById('usage-info').textContent = usageText;
                        document.getElementById('progress-fill').style.width = data.usage.percent + '%';
                    } else {
                        loadUsageInfo();
                    }
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå ' + data.message;
                }
                
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'üì§ ‰∏ä‰º†Êñá‰ª∂';
            })
            .catch(error => {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå ‰∏ä‰º†Â§±Ë¥•Ôºö' + error.message;
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'üì§ ‰∏ä‰º†Êñá‰ª∂';
            });
        });
        
        // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÂ≠òÂÇ®‰ΩøÁî®ÊÉÖÂÜµ
        document.addEventListener('DOMContentLoaded', function() {
            loadUsageInfo();
        });
    </script>
</body>
</html>
"""

# ÊàêÂäüÈ°µÈù¢Ê®°Êùø
SUCCESS_TEMPLATE = """
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∏ä‰º†ÊàêÂäü - Ê†°Âõ≠Êô∫ËÉΩÂ∞èÂä©Êâã</title>
    <style>
        body { 
            font-family: 'Microsoft YaHei', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
        }
        .success-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 400px;
        }
        .success-icon { font-size: 60px; margin-bottom: 20px; }
        h1 { color: #28a745; margin-bottom: 15px; }
        p { color: #666; margin-bottom: 25px; line-height: 1.6; }
        .btn { 
            background: #4a90e2; 
            color: white; 
            padding: 12px 30px; 
            text-decoration: none; 
            border-radius: 8px; 
            display: inline-block;
            transition: transform 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
    </style>
</head>
<body>
    <div class="success-container">
        <div class="success-icon">‚úÖ</div>
        <h1>‰∏ä‰º†ÊàêÂäüÔºÅ</h1>
        <p>{{ message }}</p>
        <a href="/" class="btn">ÁªßÁª≠‰∏ä‰º†</a>
    </div>
</body>
</html>
"""

@app.route('/')
def index():
    """ÊòæÁ§∫‰∏ä‰º†Ë°®Âçï"""
    device_info = get_device_info()
    return render_template_string(UPLOAD_TEMPLATE, 
                                device_info=device_info, 
                                form_data={})

@app.route('/upload', methods=['POST'])
def upload_knowledge():
    """Â§ÑÁêÜÁü•ËØÜ‰∏ä‰º†"""
    try:
        # Ëé∑ÂèñË°®ÂçïÊï∞ÊçÆ
        school_info = request.form.get('school_info', '').strip()
        history = request.form.get('history', '').strip()
        celebrities = request.form.get('celebrities', '').strip()
        
        # Ê£ÄÊü•ÊòØÂê¶ÊúâÂÜÖÂÆπ
        if not school_info and not history and not celebrities:
            return jsonify({
                'success': False,
                'message': 'ËØ∑Ëá≥Â∞ëÂ°´ÂÜô‰∏ÄÈ°πÂÜÖÂÆπ'
            })
        
        # Ëé∑ÂèñËÆæÂ§á‰ø°ÊÅØ‰Ωú‰∏∫Ê†áËØÜ
        device_info = get_device_info()
        device_id = f"{device_info['hostname']}_{device_info['mac']}"
        
        # ‰øùÂ≠òÂà∞Áü•ËØÜÂ∫ì
        success = knowledge_manager.add_knowledge(
            school_info=school_info,
            history=history,
            celebrities=celebrities,
            device_id=device_id
        )
        
        if success:
            # ÁªüËÆ°‰ø°ÊÅØ
            stats = knowledge_manager.get_knowledge_stats()
            total = stats.get('total', 0)
            
            return jsonify({
                'success': True,
                'message': f'Áü•ËØÜ‰∏ä‰º†ÊàêÂäüÔºÅÂΩìÂâçÁü•ËØÜÂ∫ìÂÖ±Êúâ {total} Êù°ËÆ∞ÂΩï'
            })
        else:
            return jsonify({
                'success': False,
                'message': '‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï'
            })
            
    except Exception as e:
        print(f"‰∏ä‰º†Áü•ËØÜÊó∂Âá∫Èîô: {e}")
        return jsonify({
            'success': False,
            'message': f'‰∏ä‰º†Â§±Ë¥•Ôºö{str(e)}'
        })

@app.route('/status')
def status():
    """Ëé∑ÂèñÁü•ËØÜÂ∫ìÁä∂ÊÄÅ"""
    try:
        stats = knowledge_manager.get_knowledge_stats()
        device_info = get_device_info()
        return jsonify({
            'success': True,
            'device_info': device_info,
            'knowledge_stats': stats
        })
    except Exception as e:
        return jsonify({
            'success': False,
            'message': str(e)
        })

@app.route('/kb/usage')
def get_knowledge_base_usage():
    """Ëé∑ÂèñÁü•ËØÜÂ∫ìÊñá‰ª∂Â≠òÂÇ®‰ΩøÁî®ÊÉÖÂÜµ"""
    try:
        ensure_knowledge_base_dir()
        used_bytes = get_folder_size(KNOWLEDGE_BASE_DIR)
        max_bytes = KNOWLEDGE_BASE_MAX_BYTES
        percent = (used_bytes / max_bytes * 100) if max_bytes > 0 else 0
        
        return jsonify({
            'used_bytes': used_bytes,
            'max_bytes': max_bytes,
            'used_human': format_bytes(used_bytes),
            'max_human': format_bytes(max_bytes),
            'percent': round(percent, 1)
        })
    except Exception as e:
        return jsonify({
            'error': str(e)
        }), 500

@app.route('/kb/upload', methods=['POST'])
def upload_knowledge_files():
    """Â§ÑÁêÜÁü•ËØÜÂ∫ìÊñá‰ª∂‰∏ä‰º†"""
    try:
        ensure_knowledge_base_dir()
        
        if 'files' not in request.files:
            return jsonify({
                'success': False,
                'message': 'Ê≤°ÊúâÈÄâÊã©Êñá‰ª∂'
            }), 400
        
        files = request.files.getlist('files')
        if not files or files[0].filename == '':
            return jsonify({
                'success': False,
                'message': 'Ê≤°ÊúâÈÄâÊã©Êñá‰ª∂'
            }), 400
        
        # Ê£ÄÊü•ÂΩìÂâçÂ≠òÂÇ®‰ΩøÁî®ÊÉÖÂÜµ
        current_size = get_folder_size(KNOWLEDGE_BASE_DIR)
        
        # ËÆ°ÁÆóÊâÄÊúâÊñá‰ª∂ÁöÑÊÄªÂ§ßÂ∞è
        total_upload_size = 0
        file_info = []
        
        for file in files:
            if file.filename:
                # Ê®°ÊãüËØªÂèñÊñá‰ª∂Â§ßÂ∞èÔºà‰∏çÂÆåÂÖ®Âä†ËΩΩÂà∞ÂÜÖÂ≠òÔºâ
                file.seek(0, 2)  # ÁßªÂä®Âà∞Êñá‰ª∂Êú´Â∞æ
                file_size = file.tell()
                file.seek(0)  # ÈáçÁΩÆÂà∞ÂºÄÂ§¥
                
                file_info.append({
                    'file': file,
                    'filename': file.filename,
                    'size': file_size
                })
                total_upload_size += file_size
        
        # Ê£ÄÊü•ÊÄªÂÆπÈáèÈôêÂà∂
        if current_size + total_upload_size > KNOWLEDGE_BASE_MAX_BYTES:
            return jsonify({
                'success': False,
                'message': f'Â≠òÂÇ®ÂÆπÈáè‰∏çË∂≥„ÄÇÂΩìÂâçÂ∑≤‰ΩøÁî® {format_bytes(current_size)}ÔºåÂ∞ùËØï‰∏ä‰º† {format_bytes(total_upload_size)}ÔºåÊÄªÂÆπÈáèÈôêÂà∂ {format_bytes(KNOWLEDGE_BASE_MAX_BYTES)}'
            }), 413
        
        # Â§ÑÁêÜÊØè‰∏™Êñá‰ª∂
        results = []
        saved_files = []
        
        for info in file_info:
            file = info['file']
            original_filename = info['filename']
            file_size = info['size']
            
            try:
                # Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÈôêÂà∂
                if file_size > KNOWLEDGE_BASE_MAX_FILE_BYTES:
                    results.append({
                        'filename': original_filename,
                        'success': False,
                        'message': f'Êñá‰ª∂ËøáÂ§ßÔºåÈôêÂà∂‰∏∫ {format_bytes(KNOWLEDGE_BASE_MAX_FILE_BYTES)}'
                    })
                    continue
                
                # Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
                if not is_allowed_file(original_filename):
                    results.append({
                        'filename': original_filename,
                        'success': False,
                        'message': f'‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûãÔºå‰ªÖÊîØÊåÅ: {", ".join(ALLOWED_EXTENSIONS)}'
                    })
                    continue
                
                # ÂÆâÂÖ®ÂåñÊñá‰ª∂Âêç
                safe_filename = secure_filename(original_filename)
                if not safe_filename:
                    safe_filename = f"file_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
                
                # ÁîüÊàêÂîØ‰∏ÄÊñá‰ª∂Âêç
                unique_filename = get_unique_filename(KNOWLEDGE_BASE_DIR, safe_filename)
                file_path = os.path.join(KNOWLEDGE_BASE_DIR, unique_filename)
                
                # ÊµÅÂºè‰øùÂ≠òÊñá‰ª∂Ôºà8KBÂùóÔºåÈÄÇÂêà‰ΩéÂÜÖÂ≠òËÆæÂ§áÔºâ
                with open(file_path, 'wb') as f:
                    while True:
                        chunk = file.read(8192)  # 8KB Âùó
                        if not chunk:
                            break
                        f.write(chunk)
                
                saved_files.append(unique_filename)
                results.append({
                    'filename': original_filename,
                    'saved_as': unique_filename,
                    'success': True,
                    'size': format_bytes(file_size)
                })
                
            except Exception as e:
                results.append({
                    'filename': original_filename,
                    'success': False,
                    'message': f'‰øùÂ≠òÂ§±Ë¥•: {str(e)}'
                })
        
        # Ëé∑ÂèñÊõ¥Êñ∞ÂêéÁöÑ‰ΩøÁî®ÊÉÖÂÜµ
        new_size = get_folder_size(KNOWLEDGE_BASE_DIR)
        percent = (new_size / KNOWLEDGE_BASE_MAX_BYTES * 100) if KNOWLEDGE_BASE_MAX_BYTES > 0 else 0
        
        success_count = sum(1 for r in results if r['success'])
        total_count = len(results)
        
        return jsonify({
            'success': True,
            'message': f'ÊàêÂäü‰∏ä‰º† {success_count}/{total_count} ‰∏™Êñá‰ª∂',
            'results': results,
            'usage': {
                'used_bytes': new_size,
                'max_bytes': KNOWLEDGE_BASE_MAX_BYTES,
                'used_human': format_bytes(new_size),
                'max_human': format_bytes(KNOWLEDGE_BASE_MAX_BYTES),
                'percent': round(percent, 1)
            }
        })
        
    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'‰∏ä‰º†Â§±Ë¥•: {str(e)}'
        }), 500

if __name__ == '__main__':
    print("üöÄ ÂêØÂä®Áü•ËØÜÂ∫ì‰∏ä‰º†ÊúçÂä°Âô®...")
    print("üì± ËØ∑Áî®ÊâãÊú∫ËøûÊé•ÁÉ≠ÁÇπÔºöOrangePi-Knowledge")
    print("üîó ÁÑ∂ÂêéËÆøÈóÆÔºöhttp://192.168.10.1:8080")
    print("=" * 50)
    
    # ÂêØÂä®FlaskÊúçÂä°Âô®
    app.run(
        host='0.0.0.0',  # ÁõëÂê¨ÊâÄÊúâÊé•Âè£
        port=8080,       # ‰ΩøÁî®8080Á´ØÂè£
        debug=False,     # Áîü‰∫ßÊ®°Âºè
        threaded=True    # ÊîØÊåÅÂ§öÁ∫øÁ®ã
    )